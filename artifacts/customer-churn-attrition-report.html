<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Churn & Attrition Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 18px;
            color: #718096;
        }

        .alert-box {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(245, 101, 101, 0.3);
        }

        .alert-box h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-box p {
            font-size: 16px;
            opacity: 0.95;
            line-height: 1.6;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card.critical {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }

        .metric-card.warning {
            background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
            color: white;
        }

        .metric-card.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }

        .metric-label {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-subtitle {
            font-size: 14px;
            opacity: 0.7;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        tr:hover {
            background: #fff5f5;
        }

        .cohort-name {
            font-weight: 600;
            color: #2d3748;
        }

        .number {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #4a5568;
        }

        .critical-number {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: #e53e3e;
            font-size: 16px;
        }

        .percentage {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .percentage.critical {
            background: #fed7d7;
            color: #742a2a;
        }

        .percentage.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .percentage.good {
            background: #c6f6d5;
            color: #22543d;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #fc8181;
        }

        .insight-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-card ul {
            list-style: none;
            padding: 0;
        }

        .insight-card li {
            padding: 8px 0;
            color: #4a5568;
            line-height: 1.6;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .insight-card li:before {
            content: "‚Üí";
            color: #fc8181;
            font-weight: 700;
            flex-shrink: 0;
        }

        .timeline {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .timeline h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .timeline-item {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            padding-left: 40px;
        }

        .timeline-item:before {
            content: "";
            position: absolute;
            left: 15px;
            top: 0;
            bottom: -30px;
            width: 2px;
            background: #e2e8f0;
        }

        .timeline-item:last-child:before {
            display: none;
        }

        .timeline-marker {
            position: absolute;
            left: 0;
            top: 5px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            color: white;
        }

        .timeline-marker.critical {
            background: #fc8181;
        }

        .timeline-marker.warning {
            background: #f6ad55;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-content h3 {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .timeline-content .value {
            font-size: 32px;
            font-weight: 700;
            color: #e53e3e;
            margin-bottom: 5px;
        }

        .timeline-content p {
            color: #718096;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Customer Churn & Attrition Analysis</h1>
            <p>Comprehensive Overview of Customer Loss Patterns</p>
        </div>

        <div class="alert-box">
            <h2>
                <span style="font-size: 32px;">‚ö†Ô∏è</span>
                Critical Churn Alert
            </h2>
            <p>Out of <strong>200,031 total customers</strong>, <strong>143,368 customers (71.7%)</strong> have churned after more than 90 days. This represents a significant retention challenge requiring immediate attention.</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card critical">
                <div class="metric-label">Total Customers</div>
                <div class="metric-value">200,031</div>
                <div class="metric-subtitle">baseline customer count</div>
            </div>
            <div class="metric-card critical">
                <div class="metric-label">90+ Days Churn</div>
                <div class="metric-value">143,368</div>
                <div class="metric-subtitle">71.7% churned</div>
            </div>
            <div class="metric-card warning">
                <div class="metric-label">Total Churned</div>
                <div class="metric-value">200,031</div>
                <div class="metric-subtitle">all time periods combined</div>
            </div>
            <div class="metric-card info">
                <div class="metric-label">30 Days Churn</div>
                <div class="metric-value">1,086</div>
                <div class="metric-subtitle">0.5% churned early</div>
            </div>
        </div>

        <div class="timeline">
            <h2>Churn Timeline: Customer Loss by Period</h2>

            <div class="timeline-item">
                <div class="timeline-marker warning">30d</div>
                <div class="timeline-content">
                    <h3>30 Days Customer Churn</h3>
                    <div class="value">1,086</div>
                    <p>0.54% of total customers churned within the first 30 days</p>
                </div>
            </div>

            <div class="timeline-item">
                <div class="timeline-marker warning">30d+</div>
                <div class="timeline-content">
                    <h3>More than 30 Days Customer Churn</h3>
                    <div class="value">30,042</div>
                    <p>15.02% of total customers churned after 30 days</p>
                </div>
            </div>

            <div class="timeline-item">
                <div class="timeline-marker warning">60d+</div>
                <div class="timeline-content">
                    <h3>More than 60 Days Customer Churn</h3>
                    <div class="value">25,535</div>
                    <p>12.77% of total customers churned after 60 days</p>
                </div>
            </div>

            <div class="timeline-item">
                <div class="timeline-marker critical">90d+</div>
                <div class="timeline-content">
                    <h3>More than 90 Days Customer Churn</h3>
                    <div class="value">143,368</div>
                    <p><strong>71.67% of total customers churned after 90 days - CRITICAL LEVEL</strong></p>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2>Churn Distribution by Time Period</h2>
            <canvas id="churnChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Cumulative Churn Over Time</h2>
            <canvas id="cumulativeChart"></canvas>
        </div>

        <div class="data-table">
            <h2>Detailed Churn Breakdown</h2>
            <table>
                <thead>
                    <tr>
                        <th>Churn Cohort</th>
                        <th>Total Customers</th>
                        <th>Churned Customers</th>
                        <th>Churn Rate %</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="cohort-name">30 Days Customer Churn</td>
                        <td class="number">200,031</td>
                        <td class="critical-number">1,086</td>
                        <td><span class="percentage good">0.54%</span></td>
                        <td>‚úì Acceptable</td>
                    </tr>
                    <tr>
                        <td class="cohort-name">More than 30 Days Customer Churn</td>
                        <td class="number">200,031</td>
                        <td class="critical-number">30,042</td>
                        <td><span class="percentage warning">15.02%</span></td>
                        <td>‚ö†Ô∏è Concerning</td>
                    </tr>
                    <tr>
                        <td class="cohort-name">More than 60 Days Customer Churn</td>
                        <td class="number">200,031</td>
                        <td class="critical-number">25,535</td>
                        <td><span class="percentage warning">12.77%</span></td>
                        <td>‚ö†Ô∏è Concerning</td>
                    </tr>
                    <tr style="background: #fff5f5;">
                        <td class="cohort-name" style="font-weight: 700;">More than 90 Days Customer Churn</td>
                        <td class="number">200,031</td>
                        <td class="critical-number" style="font-size: 18px;">143,368</td>
                        <td><span class="percentage critical" style="font-size: 14px;">71.67%</span></td>
                        <td style="color: #e53e3e; font-weight: 700;">üö® CRITICAL</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="insights-grid">
            <div class="insight-card">
                <h3>üìä Key Findings</h3>
                <ul>
                    <li>71.67% of customers churn after 90 days - the highest loss period</li>
                    <li>Early churn (30 days) is relatively low at 0.54%</li>
                    <li>The 30-90 day window shows moderate churn (15.02% at 30d+)</li>
                    <li>Long-term retention is the primary challenge</li>
                </ul>
            </div>

            <div class="insight-card">
                <h3>üéØ Recommended Actions</h3>
                <ul>
                    <li>Implement 90-day engagement campaigns to prevent long-term churn</li>
                    <li>Analyze why customers disengage after the 60-90 day mark</li>
                    <li>Create retention incentives for customers approaching 60 days</li>
                    <li>Investigate common characteristics of 90+ day churned customers</li>
                </ul>
            </div>

            <div class="insight-card">
                <h3>üí° Strategic Priorities</h3>
                <ul>
                    <li>Focus retention efforts on 60-90 day customer segment</li>
                    <li>Maintain current onboarding - 30-day churn is acceptable</li>
                    <li>Develop re-engagement campaigns for dormant users</li>
                    <li>Set up early warning indicators for at-risk customers</li>
                </ul>
            </div>

            <div class="insight-card">
                <h3>üìà Impact Analysis</h3>
                <ul>
                    <li>Reducing 90+ day churn by 10% saves ~14,337 customers</li>
                    <li>Current retention rate: 28.33% (56,663 retained)</li>
                    <li>Industry benchmark for fintech: 75-80% retention</li>
                    <li>Gap to benchmark: 46.67-51.67 percentage points</li>
                </ul>
            </div>
        </div>

        <div class="chart-container">
            <h2>Churn Rate Comparison</h2>
            <canvas id="comparisonChart"></canvas>
        </div>

        <div class="data-table">
            <h2>Retention Metrics Summary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Interpretation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="cohort-name">Overall Retention Rate</td>
                        <td class="number">28.33%</td>
                        <td>56,663 customers retained from 200,031 baseline</td>
                    </tr>
                    <tr>
                        <td class="cohort-name">Overall Churn Rate</td>
                        <td class="critical-number">71.67%</td>
                        <td>143,368 customers lost (90+ days cohort)</td>
                    </tr>
                    <tr>
                        <td class="cohort-name">Early Churn (0-30 days)</td>
                        <td class="number">0.54%</td>
                        <td>Good onboarding performance</td>
                    </tr>
                    <tr>
                        <td class="cohort-name">Mid-term Churn (30-60 days)</td>
                        <td class="number">2.25%</td>
                        <td>Calculated from 30d+ and 60d+ difference</td>
                    </tr>
                    <tr>
                        <td class="cohort-name">Long-term Churn (90+ days)</td>
                        <td class="critical-number">71.67%</td>
                        <td>Critical retention issue</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="header" style="margin-top: 40px;">
            <h1 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">State-Level Churn Analysis</h1>
            <p>Customer Loss and Retention by Geographic Location</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="metric-label">Total Active (Month Start)</div>
                <div class="metric-value">119,551</div>
                <div class="metric-subtitle">across all states</div>
            </div>
            <div class="metric-card critical">
                <div class="metric-label">Total Lost</div>
                <div class="metric-value">29,784</div>
                <div class="metric-subtitle">24.9% monthly churn</div>
            </div>
            <div class="metric-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white;">
                <div class="metric-label">End of Month</div>
                <div class="metric-value">122,254</div>
                <div class="metric-subtitle">including new accounts</div>
            </div>
            <div class="metric-card info">
                <div class="metric-label">Net Growth</div>
                <div class="metric-value">+2,703</div>
                <div class="metric-subtitle">2.3% month-over-month</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>Top 15 States by Customer Loss</h2>
            <canvas id="statesLostChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>State Churn Rate Comparison (Top 20 States)</h2>
            <canvas id="stateChurnRateChart"></canvas>
        </div>

        <div class="data-table">
            <h2>Complete State-by-State Breakdown</h2>
            <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <input type="text" id="stateSearch" placeholder="Search state..." style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; width: 250px;" onkeyup="filterStateTable()">
                <select id="stateSort" onchange="sortStateTable()" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                    <option value="lost-desc">Highest Losses</option>
                    <option value="lost-asc">Lowest Losses</option>
                    <option value="churn-rate-desc">Highest Churn Rate %</option>
                    <option value="churn-rate-asc">Lowest Churn Rate %</option>
                    <option value="state">State Name A-Z</option>
                    <option value="beginning-desc">Most Customers</option>
                </select>
            </div>
            <table id="stateTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>State</th>
                        <th>Beginning of Month</th>
                        <th>Lost Customers</th>
                        <th>End of Month</th>
                        <th>Churn Rate %</th>
                        <th>Net Change</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="stateTableBody">
                </tbody>
            </table>
        </div>

        <div class="chart-container">
            <h2>Geographic Heat Map: Customer Loss Distribution</h2>
            <canvas id="stateHeatChart"></canvas>
        </div>

        <div class="insights-grid">
            <div class="insight-card">
                <h3>üèÜ Best Performing States (Lowest Churn)</h3>
                <ul id="bestStates">
                </ul>
            </div>

            <div class="insight-card" style="border-left-color: #fc8181;">
                <h3>‚ö†Ô∏è Highest Risk States (Highest Churn)</h3>
                <ul id="worstStates">
                </ul>
            </div>

            <div class="insight-card">
                <h3>üìç Largest Markets by Volume</h3>
                <ul id="largestStates">
                </ul>
            </div>

            <div class="insight-card">
                <h3>üí∞ Highest Absolute Losses</h3>
                <ul id="highestLosses">
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Churn Distribution Chart
        const churnCtx = document.getElementById('churnChart').getContext('2d');
        const churnChart = new Chart(churnCtx, {
            type: 'bar',
            data: {
                labels: ['30 Days', '30+ Days', '60+ Days', '90+ Days'],
                datasets: [{
                    label: 'Churned Customers',
                    data: [1086, 30042, 25535, 143368],
                    backgroundColor: [
                        'rgba(72, 187, 120, 0.8)',
                        'rgba(237, 137, 54, 0.8)',
                        'rgba(237, 137, 54, 0.8)',
                        'rgba(252, 129, 129, 0.9)'
                    ],
                    borderColor: [
                        'rgba(72, 187, 120, 1)',
                        'rgba(237, 137, 54, 1)',
                        'rgba(237, 137, 54, 1)',
                        'rgba(252, 129, 129, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y.toLocaleString();
                                const percentage = ((context.parsed.y / 200031) * 100).toFixed(2);
                                return `${value} customers (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Cumulative Churn Chart
        const cumulativeCtx = document.getElementById('cumulativeChart').getContext('2d');
        const cumulativeChart = new Chart(cumulativeCtx, {
            type: 'line',
            data: {
                labels: ['0 Days', '30 Days', '60 Days', '90+ Days'],
                datasets: [{
                    label: 'Cumulative Churn',
                    data: [0, 1086, 31128, 143368],
                    backgroundColor: 'rgba(252, 129, 129, 0.2)',
                    borderColor: 'rgba(252, 129, 129, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y.toLocaleString();
                                const percentage = ((context.parsed.y / 200031) * 100).toFixed(2);
                                return `${value} customers churned (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 200031,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // Comparison Chart - Churn vs Retention
        const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
        const comparisonChart = new Chart(comparisonCtx, {
            type: 'doughnut',
            data: {
                labels: ['Churned (90+ days)', 'Retained'],
                datasets: [{
                    data: [143368, 56663],
                    backgroundColor: [
                        'rgba(252, 129, 129, 0.8)',
                        'rgba(72, 187, 120, 0.8)'
                    ],
                    borderColor: [
                        'rgba(252, 129, 129, 1)',
                        'rgba(72, 187, 120, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.toLocaleString();
                                const percentage = ((context.parsed / 200031) * 100).toFixed(2);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // State-level data
        const stateData = [
            { state: "Texas", beginning: 19915, lost: 4635, end: 22079 },
            { state: "California", beginning: 11741, lost: 2690, end: 12105 },
            { state: "Florida", beginning: 11169, lost: 3436, end: 10776 },
            { state: "New York", beginning: 6955, lost: 1906, end: 6782 },
            { state: "North Carolina", beginning: 4449, lost: 968, end: 5408 },
            { state: "Georgia", beginning: 4973, lost: 1219, end: 4938 },
            { state: "Illinois", beginning: 4096, lost: 1058, end: 4046 },
            { state: "New Jersey", beginning: 3569, lost: 988, end: 3440 },
            { state: "Tennessee", beginning: 3308, lost: 786, end: 3333 },
            { state: "Ohio", beginning: 3362, lost: 800, end: 3288 },
            { state: "Indiana", beginning: 3260, lost: 768, end: 3111 },
            { state: "Louisiana", beginning: 2792, lost: 615, end: 3213 },
            { state: "Pennsylvania", beginning: 2922, lost: 798, end: 3021 },
            { state: "Colorado", beginning: 2428, lost: 685, end: 2307 },
            { state: "Michigan", beginning: 2026, lost: 486, end: 2435 },
            { state: "Virginia", beginning: 2104, lost: 549, end: 2069 },
            { state: "Alabama", beginning: 2103, lost: 456, end: 2120 },
            { state: "South Carolina", beginning: 1859, lost: 433, end: 1872 },
            { state: "Maryland", beginning: 1798, lost: 445, end: 1801 },
            { state: "Wisconsin", beginning: 1896, lost: 372, end: 1855 },
            { state: "Kentucky", beginning: 1787, lost: 438, end: 1684 },
            { state: "Arizona", beginning: 1626, lost: 451, end: 1611 },
            { state: "Oklahoma", beginning: 1632, lost: 368, end: 1621 },
            { state: "Missouri", beginning: 1583, lost: 328, end: 1656 },
            { state: "Utah", beginning: 1427, lost: 369, end: 1385 },
            { state: "Nevada", beginning: 1424, lost: 427, end: 1278 },
            { state: "Minnesota", beginning: 1329, lost: 321, end: 1291 },
            { state: "Arkansas", beginning: 1318, lost: 284, end: 1324 },
            { state: "Washington", beginning: 1185, lost: 319, end: 1158 },
            { state: "Massachusetts", beginning: 1141, lost: 337, end: 1079 },
            { state: "Mississippi", beginning: 1109, lost: 266, end: 1102 },
            { state: "Kansas", beginning: 1045, lost: 222, end: 1037 },
            { state: "Oregon", beginning: 903, lost: 230, end: 857 },
            { state: "Iowa", beginning: 883, lost: 197, end: 848 },
            { state: "Connecticut", beginning: 771, lost: 214, end: 764 },
            { state: "New Mexico", beginning: 606, lost: 168, end: 588 },
            { state: "Nebraska", beginning: 614, lost: 157, end: 576 },
            { state: "Idaho", beginning: 441, lost: 97, end: 426 },
            { state: "South Dakota", beginning: 295, lost: 52, end: 287 },
            { state: "Delaware", beginning: 274, lost: 69, end: 258 },
            { state: "North Dakota", beginning: 231, lost: 52, end: 229 },
            { state: "West Virginia", beginning: 213, lost: 61, end: 214 },
            { state: "Rhode Island", beginning: 214, lost: 53, end: 207 },
            { state: "District of Columbia", beginning: 135, lost: 39, end: 142 },
            { state: "Wyoming", beginning: 122, lost: 29, end: 121 },
            { state: "Montana", beginning: 112, lost: 34, end: 101 },
            { state: "Maine", beginning: 98, lost: 21, end: 106 },
            { state: "Hawaii", beginning: 78, lost: 31, end: 71 },
            { state: "New Hampshire", beginning: 77, lost: 16, end: 77 },
            { state: "Vermont", beginning: 64, lost: 10, end: 69 },
            { state: "Alaska", beginning: 43, lost: 15, end: 46 },
            { state: "Puerto Rico", beginning: 3, lost: 1, end: 4 }
        ];

        // Calculate churn rate and net change
        stateData.forEach(state => {
            state.churnRate = ((state.lost / state.beginning) * 100).toFixed(2);
            state.netChange = state.end - state.beginning;
        });

        let filteredStateData = [...stateData];

        // States Lost Chart
        const statesLostCtx = document.getElementById('statesLostChart').getContext('2d');
        const topLostStates = [...stateData].sort((a, b) => b.lost - a.lost).slice(0, 15);
        const statesLostChart = new Chart(statesLostCtx, {
            type: 'bar',
            data: {
                labels: topLostStates.map(s => s.state),
                datasets: [{
                    label: 'Customers Lost',
                    data: topLostStates.map(s => s.lost),
                    backgroundColor: 'rgba(252, 129, 129, 0.8)',
                    borderColor: 'rgba(252, 129, 129, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const state = topLostStates[context.dataIndex];
                                return `${context.parsed.y.toLocaleString()} lost (${state.churnRate}% churn rate)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // State Churn Rate Chart
        const stateChurnRateCtx = document.getElementById('stateChurnRateChart').getContext('2d');
        const topChurnStates = [...stateData].filter(s => s.beginning > 100).sort((a, b) => b.churnRate - a.churnRate).slice(0, 20);
        const stateChurnRateChart = new Chart(stateChurnRateCtx, {
            type: 'bar',
            data: {
                labels: topChurnStates.map(s => s.state),
                datasets: [{
                    label: 'Churn Rate %',
                    data: topChurnStates.map(s => parseFloat(s.churnRate)),
                    backgroundColor: topChurnStates.map(s => {
                        const rate = parseFloat(s.churnRate);
                        if (rate >= 30) return 'rgba(252, 129, 129, 0.8)';
                        if (rate >= 25) return 'rgba(246, 173, 85, 0.8)';
                        return 'rgba(72, 187, 120, 0.8)';
                    }),
                    borderColor: topChurnStates.map(s => {
                        const rate = parseFloat(s.churnRate);
                        if (rate >= 30) return 'rgba(252, 129, 129, 1)';
                        if (rate >= 25) return 'rgba(246, 173, 85, 1)';
                        return 'rgba(72, 187, 120, 1)';
                    }),
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const state = topChurnStates[context.dataIndex];
                                return `${context.parsed.x}% (${state.lost.toLocaleString()} of ${state.beginning.toLocaleString()})`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // State Heat Chart
        const stateHeatCtx = document.getElementById('stateHeatChart').getContext('2d');
        const statesByLoss = [...stateData].sort((a, b) => b.lost - a.lost).slice(0, 25);
        const stateHeatChart = new Chart(stateHeatCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'States',
                    data: statesByLoss.map(s => ({
                        x: s.beginning,
                        y: parseFloat(s.churnRate),
                        r: Math.sqrt(s.lost) * 2
                    })),
                    backgroundColor: 'rgba(252, 129, 129, 0.6)',
                    borderColor: 'rgba(252, 129, 129, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const state = statesByLoss[context.dataIndex];
                                return `${state.state}: ${state.beginning.toLocaleString()} customers, ${state.churnRate}% churn, ${state.lost.toLocaleString()} lost`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Beginning of Month Customers'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Churn Rate %'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // Render state table
        function renderStateTable(data = filteredStateData) {
            const tbody = document.getElementById('stateTableBody');
            tbody.innerHTML = '';

            data.forEach((state, index) => {
                const churnClass = parseFloat(state.churnRate) >= 30 ? 'critical' :
                                  parseFloat(state.churnRate) >= 25 ? 'warning' : 'good';
                const status = parseFloat(state.churnRate) >= 30 ? 'üö® Critical' :
                              parseFloat(state.churnRate) >= 25 ? '‚ö†Ô∏è Warning' : '‚úì Good';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="cohort-name">${state.state}</td>
                    <td class="number">${state.beginning.toLocaleString()}</td>
                    <td class="critical-number">${state.lost.toLocaleString()}</td>
                    <td class="number">${state.end.toLocaleString()}</td>
                    <td><span class="percentage ${churnClass}">${state.churnRate}%</span></td>
                    <td class="number" style="color: ${state.netChange >= 0 ? '#38a169' : '#e53e3e'};">
                        ${state.netChange >= 0 ? '+' : ''}${state.netChange.toLocaleString()}
                    </td>
                    <td>${status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Filter state table
        function filterStateTable() {
            const searchValue = document.getElementById('stateSearch').value.toLowerCase();
            filteredStateData = stateData.filter(s => s.state.toLowerCase().includes(searchValue));
            sortStateTable();
        }

        // Sort state table
        function sortStateTable() {
            const sortBy = document.getElementById('stateSort').value;

            switch(sortBy) {
                case 'lost-desc':
                    filteredStateData.sort((a, b) => b.lost - a.lost);
                    break;
                case 'lost-asc':
                    filteredStateData.sort((a, b) => a.lost - b.lost);
                    break;
                case 'churn-rate-desc':
                    filteredStateData.sort((a, b) => b.churnRate - a.churnRate);
                    break;
                case 'churn-rate-asc':
                    filteredStateData.sort((a, b) => a.churnRate - b.churnRate);
                    break;
                case 'state':
                    filteredStateData.sort((a, b) => a.state.localeCompare(b.state));
                    break;
                case 'beginning-desc':
                    filteredStateData.sort((a, b) => b.beginning - a.beginning);
                    break;
            }

            renderStateTable(filteredStateData);
        }

        // Populate insight cards
        const bestPerforming = [...stateData].filter(s => s.beginning > 100).sort((a, b) => a.churnRate - b.churnRate).slice(0, 5);
        const worstPerforming = [...stateData].filter(s => s.beginning > 100).sort((a, b) => b.churnRate - a.churnRate).slice(0, 5);
        const largest = [...stateData].sort((a, b) => b.beginning - a.beginning).slice(0, 5);
        const highestLoss = [...stateData].sort((a, b) => b.lost - a.lost).slice(0, 5);

        document.getElementById('bestStates').innerHTML = bestPerforming.map(s =>
            `<li>${s.state}: ${s.churnRate}% churn (${s.lost.toLocaleString()} lost)</li>`
        ).join('');

        document.getElementById('worstStates').innerHTML = worstPerforming.map(s =>
            `<li>${s.state}: ${s.churnRate}% churn (${s.lost.toLocaleString()} lost)</li>`
        ).join('');

        document.getElementById('largestStates').innerHTML = largest.map(s =>
            `<li>${s.state}: ${s.beginning.toLocaleString()} customers (${s.churnRate}% churn)</li>`
        ).join('');

        document.getElementById('highestLosses').innerHTML = highestLoss.map(s =>
            `<li>${s.state}: ${s.lost.toLocaleString()} lost (${s.churnRate}% churn rate)</li>`
        ).join('');

        // Initial render
        sortStateTable();
    </script>
</body>
</html>